---
title: "Willow_statistics"
author: "Nora Bull"
date: "25 8 2021"
output: html_document
---



### Willow statistics


# Imports
```{r, eval=FALSE}
library(dplyr)
library(plyr)
```

# Hypothesis test

### Calculation of p-values for all GDRs

Procedure to find number of samples needed for 90% significance level:
  The variable `num_perm_samples` was edited and tested for multiple values, until `high_q` had a value of ~0.9. 

```{r}
prob = 0.05
var_p = prob * (1 - prob)
num_perm_samples = 70    # 70 = empirical p val = 0.1
var_p_n = var_p / num_perm_samples
sd_p_n = sqrt(var_p_n)

# 0.025 quantile
low_q = max(0, (prob-1.96*sd_p_n))

# 0.0975 quantile of true empirical p-val
high_q = prob + 1.96 * sd_p_n

print(low_q)
print(high_q)
```


## Function to perform p-val caluclation for one file
```{r}

# Dummy
GDRnullFile <- superFiles[3]
GDRnullFile <- "C:/Users/norab/Master/Data/GDRnull/refined_values/super/GDRnullSuper_ENSG00000178814___OPLA.csv"
GDRnullFile <- "C:/Users/norab/Master/Data/GDRnull/refined_values/super/GDRnullSuper_ENSG00000134121___NCHL1.csv"
GDRnullFile <- "C:/Users/norab/Master/Data/GDRnull/refined_values/super/GDRnullSuper_ENSG00000284869___SELB.csv"
GDRnullFile <- "C:/Users/norab/Master/data/simulation/simNull/simNull_5.csv"


pvalSaveFile <- file_super
GDRs <- GDRsuper

calcAndSave_pval <- function(GDRnullFile, GDRs, pvalSaveFile) {
  
  # Read data
  GDRnullData <- read.csv(GDRnullFile) # Swap to file
  gene.name <- gsub("^.*_EN", "EN", GDRnullFile)
  gene.name <- gsub(".csv$", "", gene.name)
  GDRval <- GDRs$GDR[GDRs$gene == gene.name]
  
  P = ecdf(GDRnullData$GDRnull)    # The function giving empirical CDF of GDRnull_values
  p_val = P(GDRval)                # Returns empirical CDF at GDRtrue, ie. calculated GDR for populations
                                   # Save p val for next step - multiple testing correcting
  plot(P)                         # Plot the shit (dont do for all, make an example or two...
  # Save p val to file
  cat(c(gene.name, p_val), file = pvalSaveFile, sep = ",", append = TRUE)
  cat('\n', file = pvalSaveFile, append=TRUE)
}
```


## Run p-val calulcation for 1055 trees
```{r}

# Load calculated GDRs
GDRsuper <- read.csv("C:/Users/norab/Master/thesis_data/result_data/GDR/GDRsuper_all.csv", header = TRUE)
GDRsub <- read.csv("C:/Users/norab/Master/thesis_data/result_data/GDR/GDRsub_all.csv", header = TRUE)

# Create file to save p values:
file_super <- "C:/Users/norab/Master/thesis_data/result_data/GDR/GDRnull_pval_super.csv"
file.create(file_super)
file_sub <- "C:/Users/norab/Master/thesis_data/result_data/GDR/GDRnull_pval_sub.csv"
file.create(file_sub)

# Create filelist to process
superFiles <- list.files(path="C:/Users/norab/Master/thesis_data/result_data/GDRnull/super", full.names=TRUE, recursive=FALSE)
subFiles <- list.files(path="C:/Users/norab/Master/thesis_data/result_data/GDRnull/sub", full.names=TRUE, recursive=FALSE)

# Action
super <- sapply(superFiles, calcAndSave_pval, GDRsuper, file_super)
sub <- sapply(subFiles, calcAndSave_pval, GDRsub, file_sub)

```

# Multiple testing correcting
```{r}

# Read data
p_vals_super <- read.csv("C:/Users/norab/Master/thesis_data/result_data/GDRnull/GDRnull_pval_super.csv", sep=",", col.names = c("gene", "pval"))
p_vals_sub <- read.csv("C:/Users/norab/Master/thesis_data/result_data/GDRnull/GDRnull_pval_sub.csv", sep=",", col.names = c("gene", "pval"))

# adjust
p_vals_super$pval_adj <- p.adjust(p_vals_super$pval)
p_vals_sub$pval_adj <- p.adjust(p_vals_sub$pval)

# Add GDR
SUPERdata <- inner_join(p_vals_super, GDRsuper, by = "gene")
SUBdata <- inner_join(p_vals_sub, GDRsub, by = "gene")

```

# Save gene list
```{r}
genes = keep_genes_super$gene
genes50 = keep_genes_super_GDR_50$gene
genes2 <- sapply(genes, function (x) gsub("^ENS.*___", "", x))
genes3 <-  sapply(genes, function (x) gsub("___.*$", "", x))
genes50lowest <- sapply(genes50, function (x) gsub("___.*$", "", x))

# Save
lapply(genes, write, "C:/Users/norab/Master/data/GDR/GDR1005_significantGenesFullname.csv", append=TRUE)
lapply(SUPERdata, write, "C:/Users/norab/Master/data/GDR/GDR1005_significantGenesSUPER.csv", append=TRUE)
write.table(SUBdata, file = "C:/Users/norab/Master/data/GDR/GDR1005_significantGenesSUB.csv", quote = FALSE, sep = ",", row.names = FALSE)

```

#Plot null disttribution for 4 selected genes

```{r}
GDRnullFile <- "C:/Users/norab/Master/thesis_data/result_data/GDRnull/super/SDRnull_ENSG00000134121___NCHL1.csv"
GDRsuper <- read.csv("C:/Users/norab/Master/thesis_data/result_data/GDR/GDRsuper_all.csv", header = TRUE)


GDRnullData <- read.csv(GDRnullFile) # Swap to file
gene.name <- gsub("^.*_EN", "EN", GDRnullFile)
gene.name <- gsub(".csv$", "", gene.name)
GDRval <- GDRsuper$GDR[GDRsuper$gene == gene.name]
P = ecdf(GDRnullData$SDRnull)    # The function giving empirical CDF of GDRnull_values
p_val = P(GDRval)                # Returns empirical CDF at GDRtrue, ie. calculated GDR for populations
                                   # Save p val for next step - multiple testing correcting
plot(P, main = "GDRnull: NCHL1         GDR = 0.9757", xlab = "GDR", ylab = "cumulative %")  

```


```{r}
GDRnullFile <- "C:/Users/norab/Master/Data/GDRnull/refined_values/sub/GDRnullSub_ENSG00000168653___NDUS5.csv"
GDRsub <- read.csv("C:/Users/norab/Master/data/GDR/GDRsub_all.csv", header = TRUE)


GDRnullData <- read.csv(GDRnullFile) # Swap to file
gene.name <- gsub("^.*_EN", "EN", GDRnullFile)
gene.name <- gsub(".csv$", "", gene.name)
GDRval <- GDRsub$GDR[GDRsub$gene == gene.name]
P = ecdf(GDRnullData$GDRnull)    # The function giving empirical CDF of GDRnull_values
p_val = P(GDRval)                # Returns empirical CDF at GDRtrue, ie. calculated GDR for populations
                                   # Save p val for next step - multiple testing correcting
plot(P, main = "GDRnull: NDUS5         GDR = 0.953", xlab = "GDR", ylab = "cumulative %")  

```



# Plot one null distribution

```{r}
install.packages("ggplot")
library(ggplot2)
# Filled Density Plot
ggplot(GDRnullData, aes(x = SDRnull)) + 
       geom_histogram(color = "red", # Curve color
                    fill = "purple",  # Area color
                    alpha = 0.5)   # Area transparency
```
