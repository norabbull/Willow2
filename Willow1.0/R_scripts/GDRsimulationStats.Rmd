---
title: "GDRsimulationStats"
author: "Nora Bull"
date: "18 11 2021"
output: html_document
---


# Willow statistics simulation

Notes: 
- Remove all "dummy's"
```{r}
# Dummy

#GDRnullFile<- "C:/Users/norab/Master/thesis_data/simulation/simData/randSimG9_P5.csv"  # Dummy

calcAndSave_simNull_pval <- function(GDRnullFile, pvalSaveFile) {
  
  # Read data
  GDRnullData <- read.csv(GDRnullFile)
  col = colnames(GDRnullData)
  data = unlist(strsplit(col, '_'))
  G = gsub("G", "", data[1])
  perm = gsub("P", "", data[2])
  GDR = as.double(gsub("GDR", "", data[3]))
  uniq_pvals = length(unique(GDRnullData[,1]))
  
  
  P = ecdf(GDRnullData[,1])    # The function giving empirical CDF of GDRnull_values
  p_val = P(GDR)               # Returns empirical CDF at GDRtrue, ie. calculated GDR for populations
                               # Save p val for next step - multiple testing correcting
  # plot(P)                      # Plot the shit (dont do for all, make an example or two...
  # Save p val to file
  #GDR <- as.character(GDR)
  cat(c(G, perm, GDR, uniq_pvals, p_val), file = pvalSaveFile, sep = ",", append = TRUE)
  cat('\n', file = pvalSaveFile, append=TRUE)
}


```

# Run p-value 
```{r}

# Create file to save p values:
save_file <- "C:/Users/norab/Master/thesis_data/simulation/simNull_pvals.csv"
file.create(save_file)

# Write header to file
cat(c("group_size", "permutations", "GDR", "n_uniq_pvals", "pval"), file = simNull_pvals_file, append=TRUE)

# Create list of files to process
simNullFiles <- list.files(path="C:/Users/norab/Master/thesis_data/simulation/simData/", full.names=TRUE, recursive=FALSE)

# Apply calcAndSave_simNull_pval function to all simNullFiles
test <- sapply(simNullFiles, calcAndSave_simNull_pval, save_file)

```


# Plot CDF for four simumlated instances

Retrieve cdf and p_val for 4 files:

The 4 scenarios of simulated GDR value distributions are plotted: 

G = number of group samples
P = number of permuted samples

  1. Low G, low P
  2. Low G, high P
  3. High G, low P
  4. High G, low P

Low = 20 % permuted samples
High = 80 % permuted samples

### Function to plot 
```{r}

ecdf_pval <- function(GDRnullFile, title) {
  
  # Read data
  GDRnullData <- read.csv(GDRnullFile)
  col = colnames(GDRnullData)
  data = unlist(strsplit(col, '_'))
  G = gsub("G", "", data[1])
  perm = gsub("P", "", data[2])
  GDR = as.double(gsub("GDR", "", data[3]))
  
  P = ecdf(GDRnullData[,1])    # The function giving empirical CDF of simGDR
  p_val = P(GDR)               # Returns empirical CDF for simGDR
  
  # Plot
  title = paste0("simGDR: ", title)
  plot(P, main = title, xlim=c(0,1), ylab="Probability", xlab="GDR")          
  
  abline(v=GDR, col="red", lwd = 2, lty = 2)
  abline(h=p_val, col="purple", lwd = 2, lty = 2)
  GDRlab = paste("GDR = ",round(GDR, 2))
  p_valLab = paste("p-val = ", p_val)
  legend(x=0, y=1,c(GDRlab, p_valLab), col=c("red", "purple"), lty=2, cex=0.8)
  
  print(p_val)
  return(GDR)}

```

### Plot
```{r}
# Files to plot
randSimG20_P4 <- "C:/Users/norab/Master/thesis_data/simulation/simData/randSimG20_P4.csv"
randSimG20_P16 <- "C:/Users/norab/Master/thesis_data/simulation/simData/randSimG20_P16.csv"
randSimG190_P38 <- "C:/Users/norab/Master/thesis_data/simulation/simData/randSimG190_P38.csv"
randSimG190_P152 <- "C:/Users/norab/Master/thesis_data/simulation/simData/randSimG190_P152.csv"

# Plot
ecdf_pval(randSimG20_P4, title = "G20 / P4")
ecdf_pval(randSimG20_P16, title = "G20 / P16")
ecdf_pval(randSimG190_P38, title = "G190 / P38")
ecdf_pval(randSimG190_P152, title = "G190 / P152")

```

```{r}
plot(vals1[2])
```

