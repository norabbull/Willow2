---
title: "Willow_statistics"
author: "Nora Bull"
date: "25 8 2021"
output: html_document
---



### Willow statistics



# Imports
```{r}
install.packages("plyr")
library(dplyr)
library(plyr)
```

```{r}
prob = 0.05
var_p = prob * (1 - prob)
num_perm_samples = 109      # 70 = empirical p val = 0.1
var_p_n = var_p / num_perm_samples
sd_p_n = sqrt(var_p_n)

# 0.025 quantile
low_q = max(0, (prob-1.96*sd_p_n))

# 0.0975 quantile of true empirical p-val
high_q = prob + 1.96 * sd_p_n

print(low_q)
print(high_q)
```

So, true empirical p-value for 100 samples is between 0.009 and 0.091. 
So, it is basically at largest at ~ 9 % level. 

For 1000 samples, it is only dropped to 0.036 - 0.0635, so around 3% more 
confidence. It is not worth the computational time, which is unfeasible. 




Cumulative distribution function

- Calculate p-value for each distribution.
- Create function 


```{r}
# Toy example:
X = rnorm(100) # X is a sample of 100 normally distributed random variables
P = ecdf(X)    # P is a function giving the empirical CDF of X
P(-1)         # This returns the empirical CDF at zero (should be close to 0.5)
[1] 0.52
plot(P)        # Draws a plot of the empirical CDF (see below)


# My data: 

SDRnull_values = []         # Numerical vector of nullSDR values for gene
P = ecdf(SDRnull_values)    # The function giving empirical CDF of SDRnull_values
p_val = P(SDRtrue)          # Returns empirical CDF at SDRtrue, ie. calculated SDR for populations
                            # Save p val for next step - multiple testing correcting
plot(P)                     # Plot the shit (dont do for all, make an example or two...)


```

## Function to perform analysis for a file

```{r}

# Dummy
SDRnullFile <- superFiles[3]
SDRnullFile <- "C:/Users/norab/Master/Data/SDRnull/refined_values/super/SDRnullSuper_ENSG00000178814___OPLA.csv"
SDRnullFile <- "C:/Users/norab/Master/Data/SDRnull/refined_values/super/SDRnullSuper_ENSG00000134121___NCHL1.csv"
SDRnullFile <- "C:/Users/norab/Master/Data/SDRnull/refined_values/super/SDRnullSuper_ENSG00000284869___SELB.csv"


pvalSaveFile <- file_super
SDRs <- SDRsuper

calcAndSave_pval <- function(SDRnullFile, SDRs, pvalSaveFile) {
  
  # Read data
  SDRnullData <- read.csv(SDRnullFile) # Swap to file
  gene.name <- gsub("^.*_EN", "EN", SDRnullFile)
  gene.name <- gsub(".csv$", "", gene.name)
  SDRval <- SDRs$SDR[SDRs$gene == gene.name]
  
  P = ecdf(SDRnullData$SDRnull)    # The function giving empirical CDF of SDRnull_values
  p_val = P(SDRval)                # Returns empirical CDF at SDRtrue, ie. calculated SDR for populations
                                   # Save p val for next step - multiple testing correcting
  plot(P)                         # Plot the shit (dont do for all, make an example or two...
  # Save p val to file
  cat(c(gene.name, p_val), file = pvalSaveFile, sep = ",", append = TRUE)
  cat('\n', file = pvalSaveFile, append=TRUE)
}
```


# Run the shit
```{r}

# Load calculated SDRs
SDRsuper <- read.csv("C:/Users/norab/Master/data/SDR/SDRsuper_all.csv", header = TRUE)
SDRsub <- read.csv("C:/Users/norab/Master/data/SDR/SDRsub_all.csv", header = TRUE)

# Create file to save p values:
file_super <- "C:/Users/norab/Master/data/SDRnull/refined_values/SDRnull_pval_super.csv"
file.create(file_super)
file_sub <- "C:/Users/norab/Master/data/SDRnull/refined_values/SDRnull_pval_sub.csv"
file.create(file_sub)

# Create filelist to process
superFiles <- list.files(path="C:/Users/norab/Master/data/SDRnull/refined_values/super", full.names=TRUE, recursive=FALSE)
subFiles <- list.files(path="C:/Users/norab/Master/data/SDRnull/refined_values/sub", full.names=TRUE, recursive=FALSE)
# Action

test <- sapply(superFiles, calcAndSave_pval, SDRsuper, file_super)
test <- sapply(subFiles, calcAndSave_pval, SDRsub, file_sub)

```

# Multiple testing correcting
```{r}

# Read data
p_vals_super <- read.csv("C:/Users/norab/Master/data/SDRnull/refined_values/SDRnull_pval_super.csv", sep=",", col.names = c("gene", "pval"))
p_vals_sub <- read.csv("C:/Users/norab/Master/data/SDRnull/refined_values/SDRnull_pval_sub.csv", sep=",", col.names = c("gene", "pval"))

# adjust
p_vals_super$pval_adj <- p.adjust(p_vals_super$pval)
p_vals_sub$pval_adj <- p.adjust(p_vals_sub$pval)

# Add SDR
SUPERdata <- inner_join(p_vals_super, SDRsuper, by = "gene")
SUBdata <- inner_join(p_vals_sub, SDRsub, by = "gene")

throw_genes_super <- p_vals_super$gene[p_vals_super$pval_adj > 0.001 ] 
keep_genes_super <- SUPERdata[SUPERdata$pval_adj < 0.001,]
keep_genes_sub <- SUBdata[SUBdata$pval_adj < 0.001,]

keep_genes_super_SDRlimit0.8 <- SUPERdata[SUPERdata$SDR < 0.8,]
```

# Save gene list
```{r}
genes = keep_genes_super_SDRlimit0.8$gene
genes2 <- sapply(genes, function (x) gsub("^ENS.*___", "", x))

# Save
lapply(genes2, write, "C:/Users/norab/Master/data/SDR/SDR1005_significantGenes_SDRlimit0.8.csv", append=TRUE)


```

#Plot null dist to check
```{r}
SDRnullFile <- "C:/Users/norab/Master/Data/SDRnull/refined_values/super/SDRnullSuper_ENSG00000134121___NCHL1.csv"
SDRsuper <- read.csv("C:/Users/norab/Master/data/SDR/SDRsuper_all.csv", header = TRUE)


SDRnullData <- read.csv(SDRnullFile) # Swap to file
gene.name <- gsub("^.*_EN", "EN", SDRnullFile)
gene.name <- gsub(".csv$", "", gene.name)
SDRval <- SDRsuper$SDR[SDRsuper$gene == gene.name]
P = ecdf(SDRnullData$SDRnull)    # The function giving empirical CDF of SDRnull_values
p_val = P(SDRval)                # Returns empirical CDF at SDRtrue, ie. calculated SDR for populations
                                   # Save p val for next step - multiple testing correcting
plot(P, main = "SDRnull: NCHL1         SDR = 0.9757", xlab = "SDR", ylab = "cumulative %")  

```


```{r}
SDRnullFile <- "C:/Users/norab/Master/Data/SDRnull/refined_values/sub/SDRnullSub_ENSG00000168653___NDUS5.csv"
SDRsub <- read.csv("C:/Users/norab/Master/data/SDR/SDRsub_all.csv", header = TRUE)


SDRnullData <- read.csv(SDRnullFile) # Swap to file
gene.name <- gsub("^.*_EN", "EN", SDRnullFile)
gene.name <- gsub(".csv$", "", gene.name)
SDRval <- SDRsub$SDR[SDRsub$gene == gene.name]
P = ecdf(SDRnullData$SDRnull)    # The function giving empirical CDF of SDRnull_values
p_val = P(SDRval)                # Returns empirical CDF at SDRtrue, ie. calculated SDR for populations
                                   # Save p val for next step - multiple testing correcting
plot(P, main = "SDRnull: NDUS5         SDR = 0.953", xlab = "SDR", ylab = "cumulative %")  

```

### Extract relevant SDRnull values
```{r}

# Read all SDRnull data
SDRnull_all_super <- read.csv("C:/Users/norab/Master/data/SDRnull/all/SDRnullTotalSuper_22.07.21.csv")
SDRnull_all_sub <- read.csv("C:/Users/norab/Master/data/SDRnull/all/SDRnullTotalSub_22.07.21.csv")

# Read list of relevant genes
SDRnull_genes <- read.csv("C:/Users/norab/Master/data/SDRnull/other/SDRnull_gene_selection.csv")
colnames(SDRnull_genes) <- c("gene")

# Extract SDRnull data for selected genes

# Info
gene_nr <- table(SDRnull_all_super['gene'])
max(gene_nr)

# Get generated SDRnull for selected genes only
SDRnull_selection_super <- dplyr::filter(SDRnull_all_super, SDRnull_all_super$gene %in% SDRnull_genes$gene)
SDRnull_selection_sub <- dplyr::filter(SDRnull_all_sub, SDRnull_all_sub$gene %in% SDRnull_genes$gene)

# Next: filter genes with more than 
CFAH_example <- filter(SDRnull_selection_super, gene == "ENSG00000000971___CFAH")

# Load SDRs for population groups
SDRsuper <- read.csv("C:/Users/norab/Master/data/SDR/SDRsuper_all.csv", header = TRUE)
SDRsub <- read.csv("C:/Users/norab/Master/data/SDR/SDRsub_all.csv", header = TRUE)



SDR_CFAH <- filter(SDRsuper, gene == "ENSG00000000971___CFAH")



```



```{r}


any(SUPERdata$gene == "ENSG00000110700___RS13")
SUPERdata[SUPERdata$gene ==  "ENSG00000110700___RS13",] 

```





